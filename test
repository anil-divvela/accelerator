<?xml version="1.0" encoding="UTF-8"?>

<mule xmlns:tracking="http://www.mulesoft.org/schema/mule/ee/tracking" xmlns:file="http://www.mulesoft.org/schema/mule/file" xmlns:dw="http://www.mulesoft.org/schema/mule/ee/dw" xmlns:metadata="http://www.mulesoft.org/schema/mule/metadata" xmlns:sap="http://www.mulesoft.org/schema/mule/sap" xmlns="http://www.mulesoft.org/schema/mule/core" xmlns:doc="http://www.mulesoft.org/schema/mule/documentation"
	xmlns:spring="http://www.springframework.org/schema/beans" 
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xsi:schemaLocation="http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans-current.xsd
http://www.mulesoft.org/schema/mule/core http://www.mulesoft.org/schema/mule/core/current/mule.xsd
http://www.mulesoft.org/schema/mule/file http://www.mulesoft.org/schema/mule/file/current/mule-file.xsd
http://www.mulesoft.org/schema/mule/ee/dw http://www.mulesoft.org/schema/mule/ee/dw/current/dw.xsd
http://www.mulesoft.org/schema/mule/sap http://www.mulesoft.org/schema/mule/sap/current/mule-sap.xsd
http://www.mulesoft.org/schema/mule/ee/tracking http://www.mulesoft.org/schema/mule/ee/tracking/current/mule-tracking-ee.xsd">
    <flow name="GIP_APO_Solution">
       <sap:inbound-endpoint connector-ref="SAP" type="function" outputXml="true" jcoGwHost="10.78.128.66" jcoGwService="3300" jcoProgramId="ECC.AB1.MuleSoft" jcoConnectionCount="07" responseTimeout="10000" doc:name="Trigger from SAP APO"/>
        <logger level="INFO" doc:name="Log"/>
        <object-to-string-transformer doc:name="Object to String"/>
        <set-payload value="#[payload.replace('&lt;SELECTION1&gt;','&lt;SELECTIONS&gt;&lt;SELECTION1&gt;')]" doc:name="Set Payload"/>
        <set-payload value="#[payload.replace('&lt;FIELD1&gt;','&lt;/SELECTIONS&gt;&lt;FIELDS&gt;&lt;FIELD1&gt;')]" doc:name="Set Payload"/>
        <set-payload value="#[payload.replace('&lt;/row&gt;','&lt;/FIELDS&gt;&lt;/row&gt;')]" doc:name="Set Payload"/>
        <dw:transform-message doc:name="Transform Message" metadata:id="bb18f618-7bb9-44ad-9aa7-d0b66fb6827a">
            <dw:input-payload doc:sample="D:\ABInbevAPO\Codebase\Test\ZSelection_POC\Zsel_Output\trigger.xml" mimeType="application/xml"/>
            <dw:set-payload><![CDATA[%dw 1.0
%output application/xml
---
{
	I_TABLE: {
		row: payload.Z_SEND_DATA.tables.I_TABLE.*row[0]
	}
}]]></dw:set-payload>
        </dw:transform-message>
        <dw:transform-message doc:name="Request to SAP ECC">
            <dw:input-payload doc:sample="D:\ABInbevAPO\Codebase\Test\ZSelection_POC\Zsel_Output\trigger1.xml"/>
            <dw:set-payload><![CDATA[%dw 1.0
%output application/xml
---
{
	RFC_READ_TABLE: {
		import: {
			DELIMITER: null,
			NO_DATA: null,
			QUERY_TABLE: payload.I_TABLE.row.TABLE,
			ROWCOUNT: null,
			ROWSKIPS: null
		},
		tables: {
			DATA: {
				row: {
					WA: payload.I_TABLE.row.TABLE
				}
			},
			(payload.I_TABLE.row.FIELDS map ((payload01 , indexOfPayload01) -> {
				FIELDS: {
					row: {
						FIELDNAME: payload01,
						OFFSET: null,
						LENGTH: null,
						TYPE: 'c',
						FIELDTEXT: payload01
					}
				}
			})),
			OPTIONS: {
			(payload.I_TABLE.row.SELECTIONS map ((payload01 , indexOfPayload01) -> {
			
				row: {
					TEXT: payload01 
				}
			
		} when ((payload01 != null) and (payload01 != ''))
			otherwise {
						
			} 
		))
		}
		}
		}
	
}]]></dw:set-payload>
        </dw:transform-message>
         <sap:outbound-endpoint exchange-pattern="request-response" connector-ref="SAP" type="function" functionName="RFC_READ_TABLE" outputXml="true" responseTimeout="10000" doc:name="SAP-ECC"/>
        <dw:transform-message doc:name="Response from SAP ECC">
            <dw:set-payload><![CDATA[%dw 1.0
%output application/json

---

payload.RFC_READ_TABLE.tables.DATA.*row map ((row , indexOfRow) -> {
	MANDT:(row.WA splitBy ",")[0],
	MATNR:(row.WA splitBy ",")[1],
	WERKS: (row.WA splitBy ",")[2],
	DISMM:(row.WA splitBy ",")[3]
	
})
]]></dw:set-payload>
        </dw:transform-message>
        <dw:transform-message doc:name="Transform ECC Response  to  APO Request" metadata:id="471d96b3-ae9a-4e77-9394-9c15c8da6fba">
            <dw:input-payload mimeType="application/json"/>
            <dw:set-payload><![CDATA[%dw 1.0
%output application/xml
---
{
	ZMULEDATAFILL: {
		tables: {
			ZMULE_TB: {
				(payload map ((payload01 , indexOfPayload01) -> {
					row: {
						DATA: payload01.DATA
						
					}
				}))
			}
		}
	}
}]]></dw:set-payload>
        </dw:transform-message>
        <sap:xml-to-function doc:name="XML to SAP Function (BAPI)"/>
        <sap:outbound-endpoint exchange-pattern="request-response" connector-ref="SAP" type="function" functionName="ZMULEDATAFILL" outputXml="true" evaluateFunctionResponse="true" responseTimeout="10000" doc:name="call SAP APO"/>


        <logger message="Completed !" level="INFO" doc:name="Flow END"/>
    </flow>
</mule>

